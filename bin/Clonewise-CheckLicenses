#!/bin/bash

function getDB()
{
#	Clonewise parse-database
	Clonewise query-cache|grep CLONED_IN_SOURCE|awk '{print $1 "/" $3}'
}

function grepForGPL()
{
	egrep '^License: .*AFPL.*|^License: .*LGPL.*|^License: .*GPL.*' $1 > /dev/null 2> /dev/null
}

function grepForPermissive()
{
	egrep '^License: .*ZPL.*|^License: .*Zope.*|^License: .*[Pp]ublic[ -].*|^License: .*MPL.*|^License: .*ISC.*|^License: .*ASL.*|^License: .*[Mm][Ii][Tt].*|^License: .*[Aa][Pp][aA][cC][Hh][Ee].*|^License: .*[Bb][Ss][Dd].*' $1 > /dev/null 2> /dev/null
}

getDB|tr / '\n'|sort -u|while read pkg; do
	grep ^$pkg/ dirlist > /dev/null 2> /dev/null && continue
	echo $pkg
	apt-get source $pkg 2>&1 > result.$$ 
	grep '^Skipping' result.$$ > /dev/null 2> /dev/null
	if [ $? -eq 0 ]; then
		continue
		dir=$(cat result.$$|grep ^Skipping|awk '{print $7}')
		echo $pkg/$dir >> dirlist
	else
		grep '^dpkg-source: info: extracting' result.$$ > /dev/null 2> /dev/null
		dir=$(grep '^dpkg-source: info: extracting' result.$$|awk '{print $6}')
		echo $pkg/$dir >> dirlist
	fi
	rm result.$$
done

getDB|while read line; do
	lib=$(echo $line|cut -d/ -f1)
	pkg=$(echo $line|cut -d/ -f2)
	lib_pkg=$(grep ^$lib/ dirlist|cut -d/ -f2)
	if [ "$lib_pkg" != "" ]; then
#		grep ^License: $lib_pkg/debian/copyright
		grepForGPL $lib_pkg/debian/copyright
		lib_gpl=$?
		grepForPermissive $lib_pkg/debian/copyright
		lib_bsd=$?
		pkg_pkg=$(grep ^$pkg/ dirlist|cut -d/ -f2)
		if [ "$pkg_pkg" != "" ]; then
#			grep ^License: $pkg_pkg/debian/copyright
			grepForGPL $pkg_pkg/debian/copyright
			pkg_gpl=$?
			grepForPermissive $pkg_pkg/debian/copyright
			pkg_bsd=$?
			if [ $lib_gpl -eq 0 -a $lib_bsd -ne 0 -a $pkg_bsd -eq 0 -a $pkg_gpl -ne 0 ]; then
				echo \'$lib\' with permissive license embedded in \'$pkg\' with GPL license.
			fi
		fi
	fi
done
