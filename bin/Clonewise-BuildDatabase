#!/bin/bash

if [ "$(id -u)" != 0 ]; then
	echo "Error. Must be superuser to build database."
	exit 1
fi

if [ $# -ne 1 ]; then
	echo Usage: $0 distro > /dev/stderr
	exit 1
fi

DISTRO=$1
FIFO_TODO=/var/lib/Clonewise/clones/distros/$DISTRO/downloads/fifo-todo
NUMTASKS=3

mkfifo $FIFO_TODO
mkfifo $FIFO_DONE

function DoWork()
{
	srcname=$1
	i=$2
	apt-get source $i > /var/lib/Clonewise/clones/distros/$DISTRO/.apt-source 2> /dev/null
	out="$(grep 'dpkg-source: info: extracting' /var/lib/Clonewise/clones/distros/$DISTRO/.apt-source|awk '{print $6}')"
	if [ "$out" != "" ]; then
		cd $out
		find . -type f -name '*.dsc' -exec dpkg-source -x {} \;
		find . -type f -name '*.zip' -exec unzip {} \;
		find . -type f -name '*.gz' -exec gunzip {} \;
		find . -type f -name '*.lzma' -exec unzlma {} \;
		find . -type f -name '*.rar' -exec unrar {} \;
		find . -type f -name '*.bz2' -exec bunzip2 {} \;
		find . -type f -name '*.bz' -exec bunzip {} \;
		find . -type f -name '*.xz' -exec unxz {} \;
		find . -type f -name '*.tar'|grep -v "\.orig\.tar$"|xargs -n 1 -r tar xf
		cd ..
		find $out -type f |while read f; do ssdeep $f 2> /dev/null|tail -n1 >> /var/lib/Clonewise/clones/distros/$DISTRO/signatures/$srcname; done
		rm -rf $out
	fi
}

function Consumer()
{
	while true; do
		read line < $FIFO_TODO
		if [ "$line" = "/" ]; then
			exit 1
		fi
		srcname=$(echo $line|cut -d/ -f2)
		i=$(echo $line|cut -d/ -f1)
		DoWork $srcname $i
	done
}

mkdir /var/lib/Clonewise/clones/distros/$DISTRO 2> /dev/null
mkdir /var/lib/Clonewise/clones/distros/$DISTRO/depends 2> /dev/null
mkdir /var/lib/Clonewise/clones/distros/$DISTRO/downloads 2> /dev/null
mkdir /var/lib/Clonewise/clones/distros/$DISTRO/features 2> /dev/null
mkdir /var/lib/Clonewise/clones/distros/$DISTRO/signatures 2> /dev/null
mkdir /var/lib/Clonewise/clones/distros/$DISTRO/cache 2> /dev/null

for j in $(seq 1 $NUMTASKS); do
	Consumer &
done

cd /var/lib/Clonewise/clones/distros/$DISTRO/downloads
list=$(apt-cache pkgnames)
rm -f /var/lib/Clonewise/clones/distros/$DISTRO/.done
rm -f /var/lib/Clonewise/clones/distros/$DISTRO/packages
rm -f /var/lib/Clonewise/clones/distros/$DISTRO/.apt-source
count=0
totlist=$(echo $list|wc -w)
for i in $list; do
	echo "#$i ($count/$totlist)"
	srcname=$(apt-cache showsrc $i|grep ^Package:|head -n1|cut -d\  -f2)
	if [ "$srcname" != "" ]; then
		echo "$srcname/$i" >> $FIFO_TODO
		read $FIFO_DONE
	fi
	echo $i/$srcname >> /var/lib/Clonewise/clones/distros/$DISTRO/packages
	((count=count+1))
done
echo "/" >> $FIFO_TODO
rm /var/lib/Clonewise/clones/distros/$DISTRO/.apt-source

cat /var/lib/Clonewise/clones/distros/$DISTRO/packages |cut -d/ -f1|while read package; do
        apt-cache depends $package |grep "^  Depends:"|awk '{print $2}'> /var/lib/Clonewise/clones/distros/$DISTRO/depends/$package
done

touch /var/lib/Clonewise/clones/distros/$DISTRO/.done
