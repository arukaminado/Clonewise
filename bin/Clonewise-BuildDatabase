#!/bin/bash

if [ "$(id -u)" != 0 ]; then
	echo "Error. Must be superuser to build database."
	exit 1
fi

DISTRO="$(grep ^DISTRIB_ID /etc/lsb-release|cut -d= -f2)-$(grep ^DISTRIB_RELEASE /etc/lsb-release|cut -d= -f2)"

mkdir /var/lib/Clonewise/clones/distros/$DISTRO
mkdir /var/lib/Clonewise/clones/distros/$DISTRO/depends
mkdir /var/lib/Clonewise/clones/distros/$DISTRO/downloads
mkdir /var/lib/Clonewise/clones/distros/$DISTRO/features
mkdir /var/lib/Clonewise/clones/distros/$DISTRO/signatures
mkdir /var/lib/Clonewise/clones/distros/$DISTRO/cache

cd /var/lib/Clonewise/clones/distros/$DISTRO/downloads
list=$(apt-cache pkgnames)
rm -f /var/lib/Clonewise/clones/distros/$DISTRO/.done
rm -f /var/lib/Clonewise/clones/distros/$DISTRO/packages
rm -f /var/lib/Clonewise/clones/distros/$DISTRO/.apt-source
count=0
totlist=$(echo $list|wc -w)
for i in $list; do
	echo "#$i ($count/$totlist)"
	srcname=$(apt-cache showsrc $i|grep ^Package:|head -n1|cut -d\  -f2)
	if [ "$srcname" != "" ]; then
		apt-get source $i > /var/lib/Clonewise/clones/distros/$DISTRO/.apt-source 2> /dev/null
		out="$(grep 'dpkg-source: info: extracting' /var/lib/Clonewise/clones/distros/$DISTRO/.apt-source|awk '{print $6}')"
		if [ "$out" != "" ]; then
			cd $out
			find . -type f -name '*.dsc' -exec dpkg-source -x {} \;
			find . -type f -name '*.zip' -exec unzip {} \;
			find . -type f -name '*.gz' -exec gunzip {} \;
			find . -type f -name '*.lzma' -exec unzlma {} \;
			find . -type f -name '*.rar' -exec unrar {} \;
			find . -type f -name '*.bz2' -exec bunzip2 {} \;
			find . -type f -name '*.bz' -exec bunzip {} \;
			find . -type f -name '*.xz' -exec unxz {} \;
			find . -type f -name '*.tar'|grep -v "\.orig\.tar$"|xargs -n 1 -r tar xf
			cd ..
			find $out -type f |while read f; do ssdeep $f 2> /dev/null|tail -n1 >> /var/lib/Clonewise/clones/distros/$DISTRO/signatures/$srcname; done
			rm -rf $out
		fi
	fi
	echo $i/$srcname >> /var/lib/Clonewise/clones/distros/$DISTRO/packages
	((count=count+1))
done
rm /var/lib/Clonewise/clones/distros/$DISTRO/.apt-source

cat /var/lib/Clonewise/clones/distros/$DISTRO/packages |cut -d/ -f1|while read package; do
        apt-cache depends $package |grep "^  Depends:"|awk '{print $2}'> /var/lib/Clonewise/clones/distros/$DISTRO/depends/$package
done

touch /var/lib/Clonewise/clones/distros/$DISTRO/.done
